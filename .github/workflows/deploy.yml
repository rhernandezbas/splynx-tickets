name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy
        run: |
          PROJECT_DIR="/opt/splynx-tickets"
          mkdir -p $PROJECT_DIR
          cd $PROJECT_DIR

          # Actualizar cÃ³digo
          if [ ! -d ".git" ]; then
            echo "ğŸ“¦ Clonando repositorio..."
            git clone https://github.com/rhernandezbas/splynx-tickets.git .
          else
            echo "ğŸ”„ Actualizando repositorio..."
            git fetch origin
            git reset --hard origin/main
          fi

          # Detener contenedores existentes
          echo "ğŸ›‘ Deteniendo contenedores..."
          docker compose down -v 2>&1 || true

          # Limpiar contenedores huÃ©rfanos
          docker ps -a | grep splynx-backend | awk '{print $1}' | xargs -r docker rm -f 2>&1 || true
          docker volume prune -f 2>&1 || true
          docker system prune -af 2>&1

          # Build y deploy
          echo "ğŸ—ï¸  Construyendo nueva imagen..."
          docker compose build --no-cache --pull 2>&1

          if [ $? -ne 0 ]; then
            echo "âŒ Error en el build"
            exit 1
          fi

          echo "ğŸš€ Iniciando contenedores..."
          docker compose up -d 2>&1

          if [ $? -ne 0 ]; then
            echo "âŒ Error al iniciar contenedores"
            docker compose logs --tail=100 backend
            exit 1
          fi

          # Ejecutar migraciones de BD
          echo "ğŸ”„ Ejecutando migraciones de base de datos..."
          docker compose exec -T backend flask db upgrade 2>&1 || echo "âš ï¸ Migraciones fallaron o no hay pendientes"

          # Verificar
          echo "â³ Esperando que el servicio estÃ© listo..."
          sleep 20

          echo "ğŸ“Š Estado de contenedores:"
          docker compose ps -a

          echo "ğŸ“‹ Ãšltimos logs del backend:"
          docker compose logs --tail=50 backend

          if ! docker compose ps | grep -q "Up"; then
            echo "âŒ Contenedor no estÃ¡ corriendo"
            docker compose logs backend
            exit 1
          fi

          echo "âœ… Despliegue completado exitosamente"
